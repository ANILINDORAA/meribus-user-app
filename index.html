<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meri Bus</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #f1f1f1;
    }
    .screen {
      display: none;
      padding: 20px;
    }
    .screen.active {
      display: block;
    }
    h1 { font-size: 24px; text-align: center; margin-bottom: 20px; }
    select, input[type="text"], button {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 16px;
    }
    .route-box {
      background: #fff;
      padding: 15px;
      margin-top: 10px;
      border-left: 5px solid green;
      border-radius: 6px;
      cursor: pointer;
    }
    .route-box:hover {
      background-color: #f3f3f3;
    }
    .map-container {
      position: relative;
      height: 400px;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      margin-top: 20px;
    }
    .route-line {
      position: absolute;
      left: 50%;
      width: 4px;
      background: #2196f3;
      top: 10%;
      height: 80%;
      transform: translateX(-50%);
    }
    .stop {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      border: 3px solid #2196f3;
      width: 14px;
      height: 14px;
      border-radius: 50%;
    }
    .stop-label {
      position: absolute;
      left: 60%;
      transform: translateY(-50%);
      background: #fff;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 14px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    .bus-icon {
      position: absolute;
      font-size: 26px;
      left: 50%;
      transform: translateX(-50%);
      transition: top 1s ease;
    }
  </style>
</head>
<body>

<div id="language-screen" class="screen active">
  <h1>‡§≠‡§æ‡§∑‡§æ ‡§ö‡•Å‡§®‡•á‡§Ç / Select Language</h1>
  <button onclick="selectLanguage('hi')">‡§π‡§ø‡§Ç‡§¶‡•Ä</button>
  <button onclick="selectLanguage('en')">English</button>
</div>

<div id="location-screen" class="screen">
  <h1>‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞ ‡§ö‡•Å‡§®‡•á‡§Ç</h1>
  <select id="state"><option value="Rajasthan">‡§∞‡§æ‡§ú‡§∏‡•ç‡§•‡§æ‡§®</option></select>
  <select id="district"><option value="Sri Ganganagar">‡§∂‡•ç‡§∞‡•Ä ‡§ó‡§Ç‡§ó‡§æ‡§®‡§ó‡§∞</option></select>
  <select id="tehsil"><option value="Anupgarh">‡§Ö‡§®‡•Ç‡§™‡§ó‡§¢‡§º</option></select>
  <button onclick="goToSearch()">‡§Ü‡§ó‡•á</button>
</div>

<div id="search-screen" class="screen">
  <h1>‡§¨‡§∏ ‡§ñ‡•ã‡§ú‡•á‡§Ç</h1>
  <input type="text" id="fromInput" placeholder="‡§ï‡§π‡§æ‡§Å ‡§∏‡•á (‡§ú‡•à‡§∏‡•á: ‡§Ö‡§®‡•Ç‡§™‡§ó‡§¢‡§º ‡§¨‡§æ‡§à‡§™‡§æ‡§∏)">
  <input type="text" id="toInput" placeholder="‡§ï‡§π‡§æ‡§Å ‡§§‡§ï (‡§ú‡•à‡§∏‡•á: ‡§Ö‡§®‡•Ç‡§™‡§ó‡§¢‡§º ‡§Ö‡§Ç‡§°‡§∞‡§¨‡•ç‡§∞‡§ø‡§ú)">
  <button onclick="searchRoute()">‡§¨‡§∏‡•á‡§Ç ‡§ñ‡•ã‡§ú‡•á‡§Ç</button>
  <div id="route-list"></div>
</div>

<div id="map-screen" class="screen">
  <h1>‡§≤‡§æ‡§á‡§µ ‡§ü‡•ç‡§∞‡•à‡§ï‡§ø‡§Ç‡§ó</h1>
  <div class="map-container">
    <div class="route-line"></div>
    <div class="stop" style="top:12%;"><div class="stop-label">‡§Ö‡§®‡•Ç‡§™‡§ó‡§¢‡§º ‡§¨‡§æ‡§à‡§™‡§æ‡§∏</div></div>
    <div class="stop" style="top:35%;"><div class="stop-label">‡§ó‡§£‡•á‡§∂ ‡§Æ‡§Ç‡§¶‡§ø‡§∞</div></div>
    <div class="stop" style="top:60%;"><div class="stop-label">‡§ï‡§®‡•â‡§ü ‡§™‡•ç‡§≤‡•á‡§∏</div></div>
    <div class="stop" style="top:85%;"><div class="stop-label">‡§Ö‡§®‡•Ç‡§™‡§ó‡§¢‡§º ‡§Ö‡§Ç‡§°‡§∞‡§¨‡•ç‡§∞‡§ø‡§ú</div></div>
    <div class="bus-icon" id="bus-icon" style="top:12%;">üöå</div>
  </div>
</div>

<script>
  const API_BASE = "https://meri-bus-server.onrender.com/api";
  let interval;

  function selectLanguage(lang) {
    localStorage.setItem('lang', lang);
    showScreen('location-screen');
  }

  function goToSearch() {
    showScreen('search-screen');
  }

  function showScreen(id) {
    document.querySelectorAll('.screen').forEach(div => div.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    if (id !== 'map-screen') stopTracking();
  }

  function searchRoute() {
    const from = document.getElementById('fromInput').value.trim();
    const to = document.getElementById('toInput').value.trim();
    const resultDiv = document.getElementById('route-list');
    resultDiv.innerHTML = '';

    if (from === '‡§Ö‡§®‡•Ç‡§™‡§ó‡§¢‡§º ‡§¨‡§æ‡§à‡§™‡§æ‡§∏' && to === '‡§Ö‡§®‡•Ç‡§™‡§ó‡§¢‡§º ‡§Ö‡§Ç‡§°‡§∞‡§¨‡•ç‡§∞‡§ø‡§ú') {
      const box = document.createElement('div');
      box.className = 'route-box';
      box.innerHTML = `<b>‡§Ö‡§®‡•Ç‡§™‡§ó‡§¢‡§º ‡§¨‡§æ‡§à‡§™‡§æ‡§∏ ‚Üí ‡§ó‡§£‡•á‡§∂ ‡§Æ‡§Ç‡§¶‡§ø‡§∞ ‚Üí ‡§ï‡§®‡•â‡§ü ‡§™‡•ç‡§≤‡•á‡§∏ ‚Üí ‡§Ö‡§®‡•Ç‡§™‡§ó‡§¢‡§º ‡§Ö‡§Ç‡§°‡§∞‡§¨‡•ç‡§∞‡§ø‡§ú</b><br>‡§≤‡§æ‡§á‡§µ ‡§ü‡•ç‡§∞‡•à‡§ï‡§ø‡§Ç‡§ó ‡§â‡§™‡§≤‡§¨‡•ç‡§ß`;
      box.onclick = () => {
        showScreen('map-screen');
        startTracking();
      };
      resultDiv.appendChild(box);
    } else {
      resultDiv.innerHTML = '<p>‡§ï‡•ã‡§à ‡§∞‡•Ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ</p>';
    }
  }

  function startTracking() {
    stopTracking();
    updateBusPosition();
    interval = setInterval(updateBusPosition, 5000);
  }

  function stopTracking() {
    if (interval) clearInterval(interval);
    interval = null;
  }

  async function updateBusPosition() {
    try {
      const res = await fetch(`${API_BASE}/track/location/route_anp_live`);
      const data = await res.json();
        if (data && data.currentLocation && data.currentLocation.coordinates) {
      const [lng, lat] = data.currentLocation.coordinates;

      const startLat = 29.1907;
      const endLat = 29.2500;
      let percent = ((lat - startLat) / (endLat - startLat)) * 73 + 12;
      percent = Math.max(5, Math.min(95, percent));

      const bus = document.getElementById('bus-icon');
      bus.style.top = percent + '%';
        } else {
            console.warn("Invalid data format from API:", data);
        }
    } catch (e) {
      console.error("Location fetch error:", e);
    }
  }
</script>

</body>
</html>
